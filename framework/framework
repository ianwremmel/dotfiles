#!/usr/bin/env bash

# Reminder: this file is used during first run and therefore must be bash 3
# compatible

set -euo pipefail

pushd framework
source ./config
source ./logging
source ./util
popd

PLUGINS=()
ENVIRONMENTS=()
APPLIED_PLUGINS=()

# Indicates if the passed-in string is the name of an environment variable
is_set () {
  set +u
  local ret=1
  if [ -n "${!1}" ]; then
    ret=0
  fi
  set -u
  return $ret
}

load_plugin_config () {
  local plugin_name=$1

  local usage_string='usage: read_config_for_pligin <plugin_name>'

  if [ "$plugin_name" == "" ]; then
    error "$usage_string"
    exit 1
  fi

  local plugin_config_list_var="DOTFILES_${plugin_name^^}_CONFIG"
  if ! is_set "$plugin_config_list_var"; then
    debug "$plugin_name has no config"
    return 0
  fi

  local config_list="${!plugin_config_list_var}"

  for config_name in "${config_list[@]}"; do
    local env_name="DOTFILES_${plugin_name^^}_CONFIG_${config_name^^}"
    set +u
    if ! is_set "$env_name"; then
      prompt_plugin_config "$plugin_name" "$config_name"
    fi
    set -u
  done
}

list_plugins () {
  for plugin in plugins/*; do
    echo "${plugin/plugins\//}"
  done
}

load_plugins () {
  for plugin in plugins/*; do
    plugin="${plugin/plugins\//}"
    log "Loading plugin $plugin"
    source "./plugins/$plugin/$plugin"
    PLUGINS+=("$plugin")
  done
}

prompt_plugin_config () {
  local plugin_name=$1
  local config_name=$2

  local usage_string='usage: prompt_plugin_config <plugin_name> <config_name>'

  if [ "$plugin_name" == "" ]; then
    error "$usage_string"
    exit 1
  fi

  if [ "$config_name" == "" ]; then
    error "$usage_string"
    exit 1
  fi

  local prompt_string
  prompt_string=$("dotfiles_${plugin_name}_prompt_string" "$config_name")

  local var_name
  var_name="DOTFILES_${plugin_name^^}_CONFIG_${config_name^^}"

  local value
  read -rp "$prompt_string: " value

  config_set "$var_name" "$value"
  # not the most efficient, but probably the easiest way to avoid messing up the
  # var name during assignment
  config_load
}

run_hook () {
  local plugin_name=$1
  local hook_name=$2
  local usage_string='usage: run_hook <plugin_name> <hook_name>'

  if [ "$plugin_name" == "" ]; then
    error "$usage_string"
    exit 1
  fi

  if [ "$hook_name" == "" ]; then
    error "$usage_string"
    exit 1
  fi

  (
    cd "plugins/$plugin_name"
    "dotfiles_${plugin_name}_${hook_name}"
  )
}

run_plugin () {
  local plugin_name=$1
  local usage_string='usage: run_plugin <plugin_name>'

  if [ "$plugin_name" == "" ]; then
    error "$usage_string"
    exit 1
  fi

  if array_contains APPLIED_PLUGINS "$plugin_name"; then
    return 0
  fi

  APPLIED_PLUGINS+=("$plugin_name")

  load_plugin_config "$plugin_name"
  # TODO run deps
  run_hook $plugin_name apply
}

run_plugins () {
  for plugin in $(list_plugins); do
    run_plugin "$plugin"
  done
}

main () {
  config_load

  load_plugins

  run_plugins
}

main
